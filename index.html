<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PM é–‹ç¥¨å°å¹«æ‰‹</title>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="config.js"></script>
  <link rel="icon" type="image/png" href="./favicon.png">
  <link rel="apple-touch-icon" href="./favicon.png">
  <link rel="apple-touch-icon" sizes="180x180" href="./favicon.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Noto Sans TC', 'sans-serif'],
            mono: ['JetBrains Mono', 'monospace'],
          },
          colors: {
            brand: {
              50: '#f0f7ff',
              100: '#e0effe',
              200: '#bae0fd',
              300: '#7cc8fb',
              400: '#36aaf5',
              500: '#0c8ee7',
              600: '#0070c4',
              700: '#01599f',
              800: '#064b83',
              900: '#0b406d',
            }
          }
        }
      }
    }
  </script>
  <style>
    [v-cloak] { display: none; }
    .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease; }
    .fade-enter-from, .fade-leave-to { opacity: 0; }
    .slide-enter-active, .slide-leave-active { transition: all 0.3s ease; }
    .slide-enter-from, .slide-leave-to { opacity: 0; transform: translateY(-10px); }
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 4px; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    input[type="checkbox"] { accent-color: #0c8ee7; }

    select {
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2364748b'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      background-size: 16px;
    }
    .markdown-output { font-family: 'JetBrains Mono', monospace; font-size: 0.875rem; line-height: 1.6; white-space: pre-wrap; word-break: break-word; }
    .markdown-output table { border-collapse: collapse; width: 100%; margin: 1rem 0; }
    .markdown-output th, .markdown-output td { border: 1px solid #e2e8f0; padding: 0.5rem; text-align: left; }
    .markdown-output th { background: #f8fafc; font-weight: 600; }
    .image-preview { position: relative; overflow: hidden; }
    .image-preview img { transition: transform 0.2s ease; }
    .image-preview:hover img { transform: scale(1.05); }
  </style>
</head>
<body class="bg-slate-50 min-h-screen font-sans">
  <div id="app" v-cloak>
    <header class="bg-white border-b border-slate-200 sticky top-0 z-50">
      <div class="max-w-5xl mx-auto px-4 py-4 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 bg-brand-500 rounded-xl flex items-center justify-center">
            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/>
            </svg>
          </div>
          <div>
            <h1 class="text-lg font-bold text-slate-800">PM é–‹ç¥¨å°å¹«æ‰‹</h1>
            <p class="text-xs text-slate-500">å¿«é€Ÿç”¢ç”Ÿé–‹ç™¼ Ticket</p>
          </div>
        </div>
        <div class="flex items-center gap-3">
          <div v-if="isLoggedIn && userRole !== 'admin' && apiStatus.available" class="text-xs text-slate-500">
            è©¦ç”¨å‰©é¤˜: <span class="font-semibold text-brand-600">{{ apiStatus.remaining }}</span> / {{ apiStatus.limit }} æ¬¡
          </div>
          <button v-if="isLoggedIn" @click="logout" class="flex items-center gap-2 px-3 py-2 text-sm rounded-lg bg-slate-100 text-slate-600 hover:bg-slate-200 transition-colors">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
            </svg>
            {{ userRole === 'admin' ? 'ç™»å‡º' : 'ç™»å‡ºè©¦ç”¨' }}
          </button>
          <button v-if="userRole !== 'admin'" @click="showApiKeyModal = true" class="flex items-center gap-2 px-3 py-2 text-sm rounded-lg transition-colors" :class="userApiKey ? 'bg-green-50 text-green-700' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"/>
            </svg>
            {{ userApiKey ? 'å·²è¨­å®š API Key' : 'è¨­å®š API Key' }}
          </button>
        </div>
      </div>
    </header>

    <main class="max-w-5xl mx-auto px-4 py-8">
      <div v-if="!apiBaseUrl && !userApiKey" class="mb-6 p-4 bg-amber-50 border border-amber-200 rounded-xl">
        <div class="flex items-start gap-3">
          <svg class="w-5 h-5 text-amber-500 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
          </svg>
          <div>
            <p class="text-sm font-medium text-amber-800">å°šæœªè¨­å®šå¾Œç«¯ API</p>
            <p class="text-xs text-amber-600 mt-1">è«‹åœ¨ config.js ä¸­è¨­å®š API_BASE_URLï¼Œæˆ–é»æ“Šå³ä¸Šè§’è¼¸å…¥è‡ªå·±çš„ API Key ä½¿ç”¨ã€‚</p>
          </div>
        </div>
      </div>

      <div v-if="apiBaseUrl && requireLogin && !isLoggedIn && !userApiKey" class="mb-6 p-6 bg-white border border-slate-200 rounded-2xl shadow-sm">
        <div class="text-center">
          <div class="w-16 h-16 bg-brand-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <svg class="w-8 h-8 text-brand-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
            </svg>
          </div>
          <h2 class="text-lg font-semibold text-slate-800 mb-2">è«‹ç™»å…¥ä½¿ç”¨è©¦ç”¨æ¨¡å¼</h2>
          <p class="text-sm text-slate-500 mb-6">æˆ–é»æ“Šå³ä¸Šè§’è¼¸å…¥è‡ªå·±çš„ API Key</p>
          <form @submit.prevent="login" class="max-w-xs mx-auto space-y-4" autocomplete="off">
            <input type="text" v-model="loginForm.username" placeholder="å¸³è™Ÿ" autocomplete="off" class="w-full px-4 py-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-brand-500 focus:border-transparent" required>
            <input type="password" v-model="loginForm.password" placeholder="å¯†ç¢¼" autocomplete="new-password" class="w-full px-4 py-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-brand-500 focus:border-transparent" required>
            <button type="submit" :disabled="isLoggingIn" class="w-full px-4 py-3 bg-brand-500 text-white font-semibold rounded-xl hover:bg-brand-600 disabled:opacity-50 transition-colors">{{ isLoggingIn ? 'ç™»å…¥ä¸­...' : 'ç™»å…¥' }}</button>
          </form>
        </div>
      </div>

      <div v-if="currentStep === 'form' && canUseApp" class="space-y-6">
        <section class="bg-white rounded-2xl p-6 shadow-sm border border-slate-200">
          <h2 class="text-base font-semibold text-slate-800 mb-4">Ticket é¡å‹</h2>
          <div class="flex gap-3">
            <label v-for="type in ticketTypes" :key="type.value" class="flex-1 relative cursor-pointer">
              <input type="radio" :value="type.value" v-model="form.type" class="peer sr-only">
              <div class="p-4 rounded-xl border-2 transition-all peer-checked:border-brand-500 peer-checked:bg-brand-50 border-slate-200 hover:border-slate-300">
                <div class="flex items-center gap-3">
                  <span class="text-2xl">{{ type.icon }}</span>
                  <div>
                    <div class="font-semibold text-slate-800">{{ type.label }}</div>
                    <div class="text-xs text-slate-500">{{ type.desc }}</div>
                  </div>
                </div>
              </div>
            </label>
          </div>
        </section>

        <section class="bg-white rounded-2xl p-6 shadow-sm border border-slate-200">
          <h2 class="text-base font-semibold text-slate-800 mb-4">åŸºæœ¬è³‡è¨Š</h2>
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-2">{{ form.type === 'feat' ? 'åŠŸèƒ½æè¿°' : 'å•é¡Œæè¿°' }} <span class="text-red-500">*</span></label>
              <textarea v-model="form.description" :placeholder="form.type === 'feat' ? 'è«‹æè¿°è¦å¯¦ä½œçš„åŠŸèƒ½...' : 'è«‹æè¿°é‡åˆ°çš„å•é¡Œ...'" class="w-full px-4 py-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-brand-500 focus:border-transparent resize-none" rows="4"></textarea>
            </div>
            <div class="grid grid-cols-3 gap-4">
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">å½±éŸ¿ç¯„åœ</label>
                <select v-model="form.scope" class="w-full px-4 py-3 pr-10 border border-slate-200 rounded-xl focus:ring-2 focus:ring-brand-500 bg-white">
                  <option value="frontend">å‰ç«¯</option>
                  <option value="backend">å¾Œç«¯</option>
                  <option value="fullstack">å…¨ç«¯</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">å„ªå…ˆç´š</label>
                <select v-model="form.priority" class="w-full px-4 py-3 pr-10 border border-slate-200 rounded-xl focus:ring-2 focus:ring-brand-500 bg-white">
                  <option value="urgent">ç·Šæ€¥</option>
                  <option value="normal">ä¸€èˆ¬</option>
                  <option value="low">ä½</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">å¹³å°</label>
                <select v-model="form.platform" class="w-full px-4 py-3 pr-10 border border-slate-200 rounded-xl focus:ring-2 focus:ring-brand-500 bg-white">
                  <option value="web">Web</option>
                  <option value="app">App</option>
                  <option value="both">å…©è€…çš†æ˜¯</option>
                </select>
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-2">Figma é€£çµ</label>
              <input type="url" v-model="form.figmaUrl" placeholder="https://www.figma.com/design/..." class="w-full px-4 py-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-brand-500">
            </div>
            <div v-if="form.type === 'fix'" class="p-4 bg-slate-50 border border-slate-200 rounded-xl">
              <div class="flex items-start gap-3">
                <svg class="w-5 h-5 text-slate-400 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                <div class="flex-1">
                  <p class="text-sm font-medium text-slate-700 mb-2">æ¸¬è©¦å¸³è™Ÿï¼ˆé¸å¡«ï¼‰</p>
                  <p class="text-xs text-slate-500 mb-3">æä¾›æ¸¬è©¦å¸³è™Ÿå¯å”åŠ©å·¥ç¨‹å¸«é‡ç¾å•é¡Œ</p>
                  <div class="grid grid-cols-2 gap-3">
                    <input type="text" v-model="form.testAccount" placeholder="å¸³è™Ÿ" class="px-3 py-2 text-sm border border-slate-200 rounded-lg focus:ring-2 focus:ring-brand-500 focus:border-transparent bg-white">
                    <input type="text" v-model="form.testPassword" placeholder="å¯†ç¢¼" class="px-3 py-2 text-sm border border-slate-200 rounded-lg focus:ring-2 focus:ring-brand-500 focus:border-transparent bg-white">
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>

        <section class="bg-white rounded-2xl p-6 shadow-sm border border-slate-200">
          <h2 class="text-base font-semibold text-slate-800 mb-4">æˆªåœ–ä¸Šå‚³</h2>
          <div @dragover.prevent="isDragging = true" @dragleave.prevent="isDragging = false" @drop.prevent="handleDrop" @click="$refs.fileInput.click()" class="border-2 border-dashed rounded-xl p-8 text-center cursor-pointer transition-colors" :class="isDragging ? 'border-brand-500 bg-brand-50' : 'border-slate-300 hover:border-brand-400'">
            <input ref="fileInput" type="file" accept="image/*" multiple class="hidden" @change="handleFileSelect">
            <svg class="w-12 h-12 mx-auto text-slate-400 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
            </svg>
            <p class="text-slate-600 mb-1">æ‹–æ›³åœ–ç‰‡è‡³æ­¤è™•ï¼Œæˆ–é»æ“Šä¸Šå‚³</p>
            <p class="text-xs text-slate-400">æ”¯æ´ PNGã€JPGã€GIFï¼Œå¯ä¸Šå‚³å¤šå¼µ</p>
          </div>
          <div v-if="form.images.length > 0" class="mt-4 grid grid-cols-4 gap-3">
            <div v-for="(img, index) in form.images" :key="index" class="image-preview relative aspect-video bg-slate-100 rounded-lg overflow-hidden group">
              <img :src="img.preview" class="w-full h-full object-cover">
              <button @click="removeImage(index)" class="absolute top-2 right-2 w-6 h-6 bg-red-500 text-white rounded-full opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
              </button>
            </div>
          </div>
        </section>

        <section class="bg-white rounded-2xl p-6 shadow-sm border border-slate-200">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-base font-semibold text-slate-800">ç¿»è­¯è¨­å®š</h2>
            <label class="relative inline-flex items-center cursor-pointer">
              <input type="checkbox" v-model="form.needTranslation" class="sr-only peer">
              <div class="w-11 h-6 bg-slate-200 peer-focus:ring-2 peer-focus:ring-brand-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-brand-500"></div>
            </label>
          </div>
          <transition name="slide">
            <div v-if="form.needTranslation" class="space-y-3">
              <p class="text-sm text-slate-500">é¸æ“‡éœ€è¦ç¿»è­¯çš„èªè¨€ï¼š</p>
              <div v-if="form.platform === 'web' || form.platform === 'both'" class="space-y-2">
                <div class="flex items-center justify-between">
                  <span class="text-sm font-medium text-slate-700">Web èªè¨€</span>
                  <button @click="toggleAllLanguages('web')" class="text-xs text-brand-600 hover:text-brand-700">{{ isAllSelected('web') ? 'å–æ¶ˆå…¨é¸' : 'å…¨é¸' }}</button>
                </div>
                <div class="flex flex-wrap gap-2">
                  <label v-for="lang in webLanguages" :key="lang.code" class="inline-flex items-center gap-2 px-3 py-1.5 rounded-lg border cursor-pointer transition-colors" :class="form.languages.includes(lang.code) ? 'border-brand-500 bg-brand-50 text-brand-700' : 'border-slate-200 hover:border-slate-300'">
                    <input type="checkbox" :value="lang.code" v-model="form.languages" class="sr-only">
                    <span class="text-sm">{{ lang.name }}</span>
                  </label>
                </div>
              </div>
              <div v-if="form.platform === 'app'" class="space-y-2">
                <div class="flex items-center justify-between">
                  <span class="text-sm font-medium text-slate-700">App èªè¨€</span>
                  <button @click="toggleAllLanguages('app')" class="text-xs text-brand-600 hover:text-brand-700">{{ isAllSelected('app') ? 'å–æ¶ˆå…¨é¸' : 'å…¨é¸' }}</button>
                </div>
                <div class="flex flex-wrap gap-2">
                  <label v-for="lang in appLanguages" :key="lang.code" class="inline-flex items-center gap-2 px-3 py-1.5 rounded-lg border cursor-pointer transition-colors" :class="form.languages.includes(lang.code) ? 'border-brand-500 bg-brand-50 text-brand-700' : 'border-slate-200 hover:border-slate-300'">
                    <input type="checkbox" :value="lang.code" v-model="form.languages" class="sr-only">
                    <span class="text-sm">{{ lang.name }}</span>
                  </label>
                </div>
              </div>
            </div>
          </transition>
        </section>

        <div class="flex justify-center">
          <button @click="generateTicket" :disabled="!canGenerate || isLoading" class="px-8 py-4 bg-brand-500 text-white font-semibold rounded-xl hover:bg-brand-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center gap-3">
            <svg v-if="isLoading" class="w-5 h-5 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
            <span>{{ isLoading ? 'ç”¢ç”Ÿä¸­...' : 'ç”¢ç”Ÿ Ticket' }}</span>
          </button>
        </div>
      </div>

      <div v-if="currentStep === 'ocr'" class="space-y-6">
        <section class="bg-white rounded-2xl p-6 shadow-sm border border-slate-200">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-base font-semibold text-slate-800">è«‹å‹¾é¸éœ€è¦ç¿»è­¯çš„æ–‡æ¡ˆ</h2>
            <button @click="toggleAllTexts" class="text-sm text-brand-600 hover:text-brand-700">{{ isAllTextsSelected ? 'å–æ¶ˆå…¨é¸' : 'å…¨é¸' }}</button>
          </div>
          <div class="space-y-2 max-h-96 overflow-y-auto">
            <label v-for="(text, index) in detectedTexts" :key="index" class="flex items-center gap-3 p-3 rounded-lg hover:bg-slate-50 cursor-pointer">
              <input type="checkbox" v-model="selectedTexts" :value="text" class="w-4 h-4 rounded">
              <span class="text-sm text-slate-700">{{ text }}</span>
            </label>
          </div>
        </section>
        <div class="flex justify-center gap-4">
          <button @click="currentStep = 'form'" class="px-6 py-3 border border-slate-300 text-slate-700 font-medium rounded-xl hover:bg-slate-50 transition-colors">è¿”å›ä¿®æ”¹</button>
          <button @click="proceedToResult" :disabled="isLoading" class="px-8 py-3 bg-brand-500 text-white font-semibold rounded-xl hover:bg-brand-600 disabled:opacity-50 transition-colors flex items-center gap-2">
            <svg v-if="isLoading" class="w-5 h-5 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
            <span>{{ isLoading ? 'ç”¢ç”Ÿä¸­...' : 'ç¹¼çºŒç”¢ç”Ÿ' }}</span>
          </button>
        </div>
      </div>

      <div v-if="currentStep === 'result'" class="space-y-6">
        <section class="bg-white rounded-2xl p-6 shadow-sm border border-slate-200">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-base font-semibold text-slate-800">Ticket å…§å®¹</h2>
            <button @click="copyToClipboard(ticketResult)" class="flex items-center gap-2 px-4 py-2 text-sm bg-slate-100 text-slate-700 rounded-lg hover:bg-slate-200 transition-colors">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
              è¤‡è£½
            </button>
          </div>
          <div class="markdown-output bg-slate-50 rounded-xl p-4 max-h-[500px] overflow-y-auto border border-slate-200">{{ ticketResult }}</div>
        </section>
        <section v-if="translationResult" class="bg-white rounded-2xl p-6 shadow-sm border border-slate-200">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-base font-semibold text-slate-800">i18n ç¿»è­¯è¡¨æ ¼</h2>
            <button @click="copyToClipboard(translationResult)" class="flex items-center gap-2 px-4 py-2 text-sm bg-slate-100 text-slate-700 rounded-lg hover:bg-slate-200 transition-colors">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
              è¤‡è£½
            </button>
          </div>
          <div class="overflow-x-auto">
            <div class="markdown-output bg-slate-50 rounded-xl p-4 border border-slate-200" v-html="renderMarkdownTable(translationResult)"></div>
          </div>
        </section>
        <div class="flex justify-center gap-4">
          <button @click="resetForm" class="px-6 py-3 border border-slate-300 text-slate-700 font-medium rounded-xl hover:bg-slate-50 transition-colors">é–‹æ–°çš„ Ticket</button>
        </div>
      </div>

      <transition name="fade">
        <div v-if="isLoading" class="fixed inset-0 bg-slate-900/50 flex items-center justify-center z-50">
          <div class="bg-white rounded-2xl p-8 shadow-xl max-w-sm w-full mx-4 text-center">
            <div class="relative w-16 h-16 mx-auto mb-4">
              <div class="absolute inset-0 rounded-full border-4 border-brand-200"></div>
              <div class="absolute inset-0 rounded-full border-4 border-brand-500 border-t-transparent animate-spin"></div>
            </div>
            <p class="text-slate-700 font-medium">{{ loadingMessage }}</p>
            <p class="text-sm text-slate-500 mt-1">è«‹ç¨å€™...</p>
          </div>
        </div>
      </transition>

      <transition name="fade">
        <div v-if="showApiKeyModal" class="fixed inset-0 bg-slate-900/50 flex items-center justify-center z-50" @click.self="showApiKeyModal = false">
          <div class="bg-white rounded-2xl p-6 shadow-xl max-w-md w-full mx-4">
            <h3 class="text-lg font-semibold text-slate-800 mb-4">è¨­å®š API Key</h3>
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">Claude API Key</label>
                <input type="password" v-model="tempApiKey" placeholder="sk-ant-..." class="w-full px-4 py-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-brand-500 focus:border-transparent">
                <p class="text-xs text-slate-500 mt-2">è¼¸å…¥è‡ªå·±çš„ API Key å¯ä¸å—æ¯æ—¥è©¦ç”¨é™åˆ¶ã€‚<a href="https://console.anthropic.com/" target="_blank" class="text-brand-600 hover:underline">å–å¾— API Key â†’</a></p>
              </div>
              <div class="flex gap-3">
                <button @click="showApiKeyModal = false" class="flex-1 px-4 py-2.5 border border-slate-300 text-slate-700 font-medium rounded-xl hover:bg-slate-50">å–æ¶ˆ</button>
                <button @click="saveApiKey" :disabled="isValidatingKey" class="flex-1 px-4 py-2.5 bg-brand-500 text-white font-medium rounded-xl hover:bg-brand-600 disabled:opacity-50 flex items-center justify-center gap-2">
                  <svg v-if="isValidatingKey" class="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                  {{ isValidatingKey ? 'é©—è­‰ä¸­...' : 'å„²å­˜' }}
                </button>
              </div>
              <div v-if="userApiKey" class="pt-3 border-t border-slate-200">
                <button @click="clearApiKey" class="text-sm text-red-600 hover:text-red-700">æ¸…é™¤å·²å„²å­˜çš„ API Key</button>
              </div>
            </div>
          </div>
        </div>
      </transition>

      <transition name="slide">
        <div v-if="toast.show" class="fixed bottom-6 right-6 z-50">
          <div class="px-4 py-3 rounded-xl shadow-lg flex items-center gap-3" :class="toast.type === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'">
            <svg v-if="toast.type === 'success'" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
            <svg v-else class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
            <span>{{ toast.message }}</span>
          </div>
        </div>
      </transition>
    </main>
  </div>

  <script>
    const { createApp, ref, reactive, computed, onMounted } = Vue;
    createApp({
      setup() {
        const apiBaseUrl = CONFIG.API_BASE_URL;
        const webLanguages = [
          { code: 'zh-CN', name: 'ç°¡é«”ä¸­æ–‡' }, { code: 'en', name: 'è‹±æ–‡' }, { code: 'ja', name: 'æ—¥æ–‡' },
          { code: 'ko', name: 'éŸ“æ–‡' }, { code: 'fr', name: 'æ³•æ–‡' }, { code: 'es', name: 'è¥¿ç­ç‰™æ–‡' },
          { code: 'pt-BR', name: 'è‘¡è„ç‰™æ–‡ï¼ˆå·´è¥¿ï¼‰' }, { code: 'de', name: 'å¾·æ–‡' }, { code: 'vi', name: 'è¶Šå—æ–‡' },
          { code: 'th', name: 'æ³°æ–‡' }, { code: 'ro', name: 'ç¾…é¦¬å°¼äºæ–‡' },
        ];
        const appLanguages = [
          { code: 'zh-CN', name: 'ç°¡é«”ä¸­æ–‡' }, { code: 'en', name: 'è‹±æ–‡' }, { code: 'ja', name: 'æ—¥æ–‡' },
          { code: 'ko', name: 'éŸ“æ–‡' }, { code: 'fr', name: 'æ³•æ–‡' },
        ];
        const ticketTypes = [
          { value: 'feat', label: 'åŠŸèƒ½é–‹ç™¼', desc: 'æ–°å¢åŠŸèƒ½', icon: 'âœ¨' },
          { value: 'fix', label: 'Bug ä¿®å¾©', desc: 'ä¿®å¾©å•é¡Œ', icon: 'ğŸ›' },
        ];

        const currentStep = ref('form');
        const isLoading = ref(false);
        const loadingMessage = ref('');
        const isDragging = ref(false);
        const showApiKeyModal = ref(false);
        const userApiKey = ref('');
        const tempApiKey = ref('');
        const apiStatus = reactive({ available: false, remaining: 0, limit: 20 });
        const requireLogin = ref(false);
        const isLoggedIn = ref(false);
        const isLoggingIn = ref(false);
        const isValidatingKey = ref(false);
        const authToken = ref('');
        const userRole = ref('');
        const loginForm = reactive({ username: '', password: '' });
        const form = reactive({
          type: 'feat', description: '', scope: 'frontend', priority: 'normal', platform: 'web',
          figmaUrl: '', images: [], needTranslation: false, languages: [],
          testAccount: '', testPassword: '',
        });
        const detectedTexts = ref([]);
        const selectedTexts = ref([]);
        const ticketResult = ref('');
        const translationResult = ref('');
        const toast = reactive({ show: false, message: '', type: 'success' });

        const canUseApp = computed(() => userApiKey.value || (!requireLogin.value || isLoggedIn.value) && apiBaseUrl);
        const canGenerate = computed(() => form.description.trim().length > 0 && canUseApp.value);
        const isAllTextsSelected = computed(() => detectedTexts.value.length > 0 && selectedTexts.value.length === detectedTexts.value.length);

        const showToast = (message, type = 'success') => { toast.message = message; toast.type = type; toast.show = true; setTimeout(() => { toast.show = false; }, 3000); };
        const checkAuthRequired = async () => { if (!apiBaseUrl) return; try { const res = await fetch(`${apiBaseUrl}/api/auth/check`); const data = await res.json(); requireLogin.value = data.requireLogin; } catch (e) {} };
        const checkApiStatus = async () => { if (!apiBaseUrl) return; try { const res = await fetch(`${apiBaseUrl}/api/status`); const data = await res.json(); Object.assign(apiStatus, data); } catch (e) {} };
        
        const login = async () => {
          if (!loginForm.username || !loginForm.password) return;
          isLoggingIn.value = true;
          try {
            const res = await fetch(`${apiBaseUrl}/api/auth/login`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(loginForm) });
            const data = await res.json();
            if (!res.ok) throw new Error(data.error || 'ç™»å…¥å¤±æ•—');
            authToken.value = data.token; userRole.value = data.role || 'demo'; isLoggedIn.value = true;
            localStorage.setItem('demo_token', data.token); localStorage.setItem('user_role', data.role || 'demo');
            showToast('ç™»å…¥æˆåŠŸ'); checkApiStatus();
          } catch (e) { showToast(e.message, 'error'); } finally { isLoggingIn.value = false; }
        };
        
        const logout = async () => {
          try { await fetch(`${apiBaseUrl}/api/auth/logout`, { method: 'POST', headers: { 'Authorization': `Bearer ${authToken.value}` } }); } catch (e) {}
          authToken.value = ''; userRole.value = ''; isLoggedIn.value = false;
          localStorage.removeItem('demo_token'); localStorage.removeItem('user_role');
          loginForm.username = ''; loginForm.password = '';
          showToast('å·²ç™»å‡º');
        };
        
        const saveApiKey = async () => {
          if (!tempApiKey.value.trim()) { showToast('è«‹è¼¸å…¥ API Key', 'error'); return; }
          isValidatingKey.value = true;
          try {
            const res = await fetch(`${apiBaseUrl}/api/verify-key`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ apiKey: tempApiKey.value })
            });
            if (!res.ok) {
              const err = await res.json();
              throw new Error(err.error || 'API Key ç„¡æ•ˆ');
            }
            userApiKey.value = tempApiKey.value; localStorage.setItem('claude_api_key', tempApiKey.value); showApiKeyModal.value = false; showToast('API Key é©—è­‰æˆåŠŸï¼Œå·²å„²å­˜');
          } catch (e) { showToast(e.message || 'API Key é©—è­‰å¤±æ•—', 'error'); }
          finally { isValidatingKey.value = false; }
        };
        const clearApiKey = () => { userApiKey.value = ''; tempApiKey.value = ''; localStorage.removeItem('claude_api_key'); showApiKeyModal.value = false; showToast('API Key å·²æ¸…é™¤'); };
        const handleFileSelect = (e) => processFiles(Array.from(e.target.files));
        const handleDrop = (e) => { isDragging.value = false; processFiles(Array.from(e.dataTransfer.files).filter(f => f.type.startsWith('image/'))); };
        const processFiles = (files) => { files.forEach(file => { const reader = new FileReader(); reader.onload = (e) => form.images.push({ file, preview: e.target.result, base64: e.target.result.split(',')[1] }); reader.readAsDataURL(file); }); };
        const removeImage = (index) => form.images.splice(index, 1);
        const isAllSelected = (platform) => (platform === 'web' ? webLanguages : appLanguages).every(l => form.languages.includes(l.code));
        const toggleAllLanguages = (platform) => { const langs = platform === 'web' ? webLanguages : appLanguages; if (isAllSelected(platform)) { form.languages = form.languages.filter(l => !langs.map(x => x.code).includes(l)); } else { form.languages.push(...langs.map(l => l.code).filter(l => !form.languages.includes(l))); } };
        const toggleAllTexts = () => { selectedTexts.value = isAllTextsSelected.value ? [] : [...detectedTexts.value]; };
        
        const callClaudeAPI = async (messages) => {
          const useOwnKey = !!userApiKey.value;
          const url = useOwnKey ? `${apiBaseUrl}/api/chat-with-key` : `${apiBaseUrl}/api/chat`;
          const headers = { 'Content-Type': 'application/json' };
          
          if (!useOwnKey && authToken.value) {
            headers['Authorization'] = `Bearer ${authToken.value}`;
          }
          
          const body = { model: CONFIG.CLAUDE_MODEL, max_tokens: CONFIG.MAX_TOKENS, messages };
          if (useOwnKey) {
            body.apiKey = userApiKey.value;
          }

          const res = await fetch(url, { method: 'POST', headers, body: JSON.stringify(body) });
          if (!res.ok) { const err = await res.json(); if (res.status === 401) { isLoggedIn.value = false; authToken.value = ''; localStorage.removeItem('demo_token'); } throw new Error(err.error?.message || err.error || 'å‘¼å« API å¤±æ•—'); }
          const data = await res.json(); if (!useOwnKey) checkApiStatus(); return data.content[0].text;
        };
        
        const generateTicket = async () => {
          if (!canGenerate.value) return;
          isLoading.value = true;
          try {
            if (form.needTranslation && form.images.length > 0) { loadingMessage.value = 'è¾¨è­˜æˆªåœ–æ–‡å­—ä¸­...'; await detectTexts(); currentStep.value = 'ocr'; isLoading.value = false; return; }
            await generateTicketContent();
            if (form.needTranslation && selectedTexts.value.length > 0) await generateTranslation();
            currentStep.value = 'result';
          } catch (error) { showToast(error.message, 'error'); } finally { isLoading.value = false; }
        };
        
        const detectTexts = async () => {
          const imageContents = form.images.map(img => ({ type: 'image', source: { type: 'base64', media_type: img.file.type, data: img.base64 } }));
          const prompt = `# Role\nä½ æ˜¯ä¸€å€‹æ–‡å­—è¾¨è­˜åŠ©æ‰‹ï¼Œè² è²¬å¾æˆªåœ–ä¸­æå–æ‰€æœ‰ UI ä¸Šçš„æ–‡å­—å…§å®¹ã€‚\n\n# Task\n1. ä»”ç´°æª¢è¦–æ¯ä¸€å¼µæˆªåœ–\n2. æå–æ‰€æœ‰å¯è¦‹çš„ UI æ–‡å­—\n3. åˆä½µæ‰€æœ‰æˆªåœ–çš„æ–‡å­—\n4. å»é™¤é‡è¤‡é …ç›®\n5. éæ¿¾æ‰ä¸éœ€ç¿»è­¯çš„å…§å®¹ï¼ˆç´”æ•¸å­—ã€emailã€ç¶²å€ã€ç‰ˆæœ¬è™Ÿï¼‰\n\n# Output Format\nç›´æ¥è¼¸å‡ºæ–‡å­—æ¸…å–®ï¼Œæ¯è¡Œä¸€å€‹ï¼Œä¸è¦åŠ ä»»ä½•å‰ç¶´ç¬¦è™Ÿæˆ–ç·¨è™Ÿ`;
          const result = await callClaudeAPI([{ role: 'user', content: [...imageContents, { type: 'text', text: prompt }] }]);
          detectedTexts.value = result.split('\n').map(t => t.trim()).filter(t => t.length > 0 && !t.startsWith('-') && !t.startsWith('â€¢'));
          selectedTexts.value = [...detectedTexts.value];
        };
        
        const proceedToResult = async () => {
          isLoading.value = true;
          try {
            loadingMessage.value = 'ç”¢ç”Ÿ Ticket å…§å®¹ä¸­...'; await generateTicketContent();
            if (form.needTranslation && selectedTexts.value.length > 0) { loadingMessage.value = 'ç”¢ç”Ÿç¿»è­¯è¡¨æ ¼ä¸­...'; await generateTranslation(); }
            currentStep.value = 'result';
          } catch (error) { showToast(error.message, 'error'); } finally { isLoading.value = false; }
        };
        
        const generateTicketContent = async () => {
          loadingMessage.value = 'ç”¢ç”Ÿ Ticket å…§å®¹ä¸­...';
          const scopeMap = { frontend: 'å‰ç«¯', backend: 'å¾Œç«¯', fullstack: 'å…¨ç«¯' };
          const priorityMap = { urgent: 'ç·Šæ€¥', normal: 'ä¸€èˆ¬', low: 'ä½' };
          const platformMap = { web: 'Web', app: 'App', both: 'å…©è€…çš†æ˜¯' };
          const imageContents = form.images.map(img => ({ type: 'image', source: { type: 'base64', media_type: img.file.type, data: img.base64 } }));
          const testAccountInfo = form.testAccount ? `- å¸³è™Ÿï¼š${form.testAccount}\n- å¯†ç¢¼ï¼š${form.testPassword || '[è«‹è£œå……]'}` : '> âš ï¸ è«‹è£œå……æ¸¬è©¦å¸³è™Ÿè³‡è¨Š';
          const template = form.type === 'feat' ? `### 1. Ticket æ¨™é¡Œ\næ ¼å¼ï¼š[feat] {é é¢åç¨±}_{åŠŸèƒ½ç°¡è¿°}\n\n### 2. éœ€æ±‚æè¿°\nä½¿ç”¨å·¢ç‹€ checkbox æ ¼å¼\n\n### 3. é©—æ”¶æ¢ä»¶ / æ¸¬è©¦è¦é»\n\n### 4. åƒè€ƒç•«é¢\n[æˆªåœ–æ”¾ç½®è™•]\n\n### 5. Figma é€£çµ\n${form.figmaUrl || '[ç„¡]'}\n\n### 6. å»ºè­° Due Day\n\n### 7. å»ºè­° Tag` : `### 1. Ticket æ¨™é¡Œ\næ ¼å¼ï¼š[fix] {é é¢åç¨±}_{å•é¡Œç°¡è¿°}\n\n### 2. å•é¡Œæè¿°\n\n### 3. å¾©ç¾æ–¹å¼\n\n### 4. æ¸¬è©¦å¸³è™Ÿ\n${testAccountInfo}\n\n### 5. é æœŸçµæœ\n\n### 6. å•é¡Œæˆªåœ– / éŒ„å½±\n[æˆªåœ–æ”¾ç½®è™•]\n\n### 7. å»ºè­° Due Day\n\n### 8. å»ºè­° Tag`;
          const testAccountPrompt = form.type === 'fix' && form.testAccount ? `\n- æ¸¬è©¦å¸³è™Ÿï¼š${form.testAccount}\n- æ¸¬è©¦å¯†ç¢¼ï¼š${form.testPassword || 'æœªæä¾›'}` : '';
          const prompt = `# Role\nä½ æ˜¯ä¸€å€‹å°ˆæ¥­çš„ PM åŠ©æ‰‹ï¼Œå°ˆé–€å”åŠ©æ’°å¯«é–‹ç™¼ ticketã€‚\n\n# Input\n- å•é¡Œ/åŠŸèƒ½æè¿°ï¼š${form.description}\n- Ticket é¡å‹ï¼š${form.type}\n- å½±éŸ¿ç¯„åœï¼š${scopeMap[form.scope]}\n- å„ªå…ˆç´šï¼š${priorityMap[form.priority]}\n- å¹³å°ï¼š${platformMap[form.platform]}\n- Figma é€£çµï¼š${form.figmaUrl || 'ç„¡'}${testAccountPrompt}\n\n# Output Format\n${template}\n\n# æ³¨æ„äº‹é …\n- ä½¿ç”¨ç¹é«”ä¸­æ–‡\n- æŠ€è¡“åè©å¯ä½¿ç”¨è‹±æ–‡\n- ä¿æŒæè¿°ç°¡æ½”ä½†å®Œæ•´\n- ä»”ç´°è§€å¯Ÿæˆªåœ–å…§å®¹ä¾†è£œå……ç´°ç¯€\n- å¦‚æœè³‡è¨Šä¸è¶³ï¼Œæ¨™è¨» [éœ€è£œå……]`;
          ticketResult.value = await callClaudeAPI([{ role: 'user', content: [{ type: 'text', text: prompt }, ...imageContents] }]);
        };
        
        const generateTranslation = async () => {
          const allLangs = form.platform === 'app' ? appLanguages : webLanguages;
          const selectedLangs = allLangs.filter(l => form.languages.includes(l.code));
          const langNames = selectedLangs.map(l => l.name).join('ã€');
          const prompt = `# Role\nä½ æ˜¯ä¸€å€‹å°ˆæ¥­çš„å¤šèªç³»ç¿»è­¯åŠ©æ‰‹ã€‚\n\n# Input\néœ€ç¿»è­¯çš„æ–‡æ¡ˆï¼š\n${selectedTexts.value.map(t => `- ${t}`).join('\n')}\n\nç›®æ¨™èªè¨€ï¼š${langNames}\n\n# Output Format\nä»¥ Markdown è¡¨æ ¼æ ¼å¼è¼¸å‡º\n\n# ç¿»è­¯åŸå‰‡\n1. ä¿æŒä¸€è‡´æ€§\n2. ç¬¦åˆå¹³å°æ…£ä¾‹\n3. é•·åº¦è€ƒé‡\n4. èªæ°£ä¸€è‡´\n5. å“ç‰Œåç¨±ä¸ç¿»è­¯`;
          translationResult.value = await callClaudeAPI([{ role: 'user', content: prompt }]);
        };
        
        const renderMarkdownTable = (md) => {
          if (!md) return '';
          const lines = md.trim().split('\n').filter(l => l.includes('|'));
          if (lines.length < 2) return md;
          let html = '<table class="min-w-full">';
          lines.forEach((line, i) => { if (line.includes('---')) return; const cells = line.split('|').filter(c => c.trim()); const tag = i === 0 ? 'th' : 'td'; html += '<tr>'; cells.forEach(cell => { html += `<${tag} class="whitespace-nowrap">${cell.trim()}</${tag}>`; }); html += '</tr>'; });
          html += '</table>'; return html;
        };
        
        const copyToClipboard = async (text) => { try { await navigator.clipboard.writeText(text); showToast('å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿'); } catch (e) { showToast('è¤‡è£½å¤±æ•—', 'error'); } };
        const resetForm = () => { Object.assign(form, { type: 'feat', description: '', scope: 'frontend', priority: 'normal', platform: 'web', figmaUrl: '', images: [], needTranslation: false, languages: [], testAccount: '', testPassword: '' }); detectedTexts.value = []; selectedTexts.value = []; ticketResult.value = ''; translationResult.value = ''; currentStep.value = 'form'; };

        onMounted(async () => {
          const savedKey = localStorage.getItem('claude_api_key'); if (savedKey) { userApiKey.value = savedKey; tempApiKey.value = savedKey; }
          const savedToken = localStorage.getItem('demo_token'); if (savedToken) { authToken.value = savedToken; isLoggedIn.value = true; }
          const savedRole = localStorage.getItem('user_role'); if (savedRole) { userRole.value = savedRole; }
          await checkAuthRequired(); checkApiStatus();
        });

        return { apiBaseUrl, webLanguages, appLanguages, ticketTypes, currentStep, isLoading, loadingMessage, isDragging, showApiKeyModal, userApiKey, tempApiKey, apiStatus, requireLogin, isLoggedIn, isLoggingIn, isValidatingKey, userRole, loginForm, form, detectedTexts, selectedTexts, ticketResult, translationResult, toast, canUseApp, canGenerate, isAllTextsSelected, login, logout, saveApiKey, clearApiKey, handleFileSelect, handleDrop, removeImage, isAllSelected, toggleAllLanguages, toggleAllTexts, generateTicket, proceedToResult, renderMarkdownTable, copyToClipboard, resetForm };
      }
    }).mount('#app');
  </script>
</body>
</html>
